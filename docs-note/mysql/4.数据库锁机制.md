---
title: mysql 锁机制
sidebar_label: mysql锁机制
---

锁的初衷是为了解决并发问题。特别是当并发访问公共资源时，更需要合理的控制资源的访问规则。   
根据加锁的范围，mysql 中大致存在三类锁机制：全局锁、表锁、行锁。

## 全局锁
全局锁是对整个数据库实例加锁。      
mysql 提供了一种加全局锁的方式：`flush tables with read lock`（FTWRL）。   
使用全局锁后，数据库实例将处于只读的状态。

现在使用全局锁的场景比较少了，以前使用全局锁最多的场景就是做数据库的全量备份。   
因为数据库引擎 MyISAM 不支持事务，所以再做全量备份时，为了保障数据安全，需要加上全局锁。   
而数据库引擎 InnoDB 支持事务，在可重复读的隔离级别下，可以安全的执行全量备份。

除了全局锁，还有一种方式可以使得数据库全局只读。那就是修改全局配置：`set global readonly=true`。   
通过这种方式也可以实现数据库只读。但是除非特殊场景，不然一般不建议这样操作，
因为在某些场景下，readonly 有特殊含义，可能会被用作主库从库的判断。   

## 表锁
mysql 中的表锁有两种：一种是**普通表锁**，另一种是**元数据锁**（meta data lock，MDL）。

申请普通表锁的方式是：`lock table xxx read/write`。比如：`lock table test1 read, test2 write`。   
这时，当前可以对 test1 表进行读操作，对 test2 表进行读写操作。而其他用户，则只能对 test1 进行读操作，而无法对 test2 进行操作。

MDL 锁不需要主动申请，在访问一个表的时候，会自动加上 MDL 读锁。在对表的结构做出修改时，会自动加上 MDL 写锁。   
因为读写锁冲突，所以当对一个访问频率很高的表执行 alter 操作时一件十分危险的事情。   

## 行锁




