---
title: TCP
---

### 什么是TCP

TCP是网络模型中传输层的通信协议。它拥有基于连接的，可靠的，面向字节的主要特征。
同时TCP是互联网中应用最多的底层协议之一，很多应用层协议（如：HTTP协议）都是基于TCP协议实现的。

### TCP报文由什么组成

TCP报文组成是很复杂的，个人在学习过程中，一般仅关注几个点核心点。

首先，TCP报文中需要申明：源IP、源端口、目标IP、目标端口 这四个关键信息。
通过这一组信息，TCP可以唯一确认一组连接。

此外，TCP报文中还有标志位用于区分此次报文是属于SYN报文、ACK报文、FIN报文等。
对应的还有序列号，用于确保数据的有序性。还有窗口大小，用于协商滑动窗口大小。

### TCP三次握手

TCP三次握手由客户端和服务端共同完成，发起方为客户端，接收方为服务端。

- 第一次握手
    - 客户端发送SYN报文，请求建立连接，并进入SYN_SENT状态
    - 报文中包含客户端初始化的随机序列号
- 第二次握手
    - 服务端收到SYN报文，向客户端回应SYN+ACK报文，并进入SYN_RECV状态，此时会创建连接对象，并放入到SYN半连接队列中
    - 报文中包含服务端初始化的随机序列号，并将客户端的序列号作为确认号一并返回
- 第三次握手
    - 客户端收到ACK报文，通过序列号确认是否属于自己的报文。
    - 然后向服务端回应ACK报文，报文中包含序列号和确认号，此时客户端进入ESTLIBALSI状态，表示连接已建立
    - 通常情况下，第三次ACK报文可以携带请求数据

### TCP四次挥手

TCP三次握手由客户端和服务端共同完成，发起方可以是客户端，也可以是服务端。下面以客户端发起挥手作为示例。

- 第一次挥手
    - 客户端发送FIN报文，请求释放连接，并进入FIN_WAIT_1状态
- 第二次挥手
    - 服务端接收到FIN报文，向客户端回应ACK报文，并进入WAIT_CLOSE状态
- 第三次挥手
    - 服务端确认无数据发送后，向客户端发送FIN报文，并进入LAST_ACK状态
- 第四次挥手
    - 客户端接收服务端FIN报文后，向服务端发送ACK报文，并进入到TIME_WAIT状态
    - 服务端收到客户端ACK报文后，正式关闭连接，进入CLOSE状态

### 请分别介绍每次握手或挥手丢失的场景
不管是三次握手还是四次挥手，要分析丢失的场景，核心就是围绕着超时重传进行分析。

### 为什么需要TCP
通过互联网进行数据传输的过程中，受限于很多因素，比如：网咯波动，硬件等，每次传输过程其实都有一定概率是会丢失的。
而TCP就是为了解决这种问题而设计的一种，面向连接的、可靠的传输协议，可以极大的保障我们数据传输过程的可靠性。

### 什么是MTU和MSS
- MTU：Maximum Transmission Unit，IP层能够传输的最大单元大小
- MSS：Maximum Segment Size，TCP层能够传输的最大数据块大小

### 什么是SYN攻击
SYN攻击是一种网络攻击方式，它通过模拟TCP三次握手中的第一次握手报文，快速占据服务端大量资源，
从而导致服务端无法处理正常请求。

具体过程：
- 服务端接收到TCP第一次握手报文，响应SYN+ACK报文，并创建连接对象加入到SYN半连接队列。
- 由于是恶意伪造的SYN报文，因此服务端是不会接收到第三次握手报文的，因此服务端会认为第二次报文丢失了，触发超时重传机制，该过程通常最大可以持续60s
- 因此服务端半连接队列大小将迅速被打满
- 在半连接被打满后，新的SYN报文将直接丢弃

### 丢包是怎么产生的

- SYN半连接队列被打满，新的SYN报文将直接丢弃


### 为什么会有TIME_WAIT状态

<!--

-->

### 请分析下服务端产生大量的TIME_WAIT

<!--

-->

### 请分析下服务端产生大量的CLOSE_WAIT

<!--

-->

### 没有Accept是否能建立TCP连接

<!--

-->

### 没有Listen是否能建立TCP连接

<!--

-->

### TCP如何保证可靠传输
主要基于超时重传和快速重传

- 超时重传


- 快速重传
当接收方接收到连续三次相同的低序列号报文时，就会触发快速重传。

### 什么是滑动窗口

### 什么是流量控制

### 什么是拥塞控制

### 为什么说TCP是慢启动


### 什么是ICMP
互联网消息控制协议，常用于：
- 异常消息回传
- 网络质量探测与优化




