<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/docusaurus/blog/rss.xml" title="Czasg RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docusaurus/blog/atom.xml" title="Czasg Atom Feed"><title data-react-helmet="true">数据库单表十亿量级的优化之路 | Czasg</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://czasg.github.io/docusaurus/blog/2022/03/18/数据库单表十亿量级的优化之路"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="数据库单表十亿量级的优化之路 | Czasg"><meta data-react-helmet="true" name="description" content="在常规数据库中，单表数据量到达百万时，查询方面就可能出现性能问题。而当单表数据量达到千万量级时，不仅查询，连索引维护也可能出现问题。"><meta data-react-helmet="true" property="og:description" content="在常规数据库中，单表数据量到达百万时，查询方面就可能出现性能问题。而当单表数据量达到千万量级时，不仅查询，连索引维护也可能出现问题。"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-03-18T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/czasg"><meta data-react-helmet="true" property="article:tag" content="数据库"><link data-react-helmet="true" rel="shortcut icon" href="/docusaurus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://czasg.github.io/docusaurus/blog/2022/03/18/数据库单表十亿量级的优化之路"><link data-react-helmet="true" rel="alternate" href="https://czasg.github.io/docusaurus/blog/2022/03/18/数据库单表十亿量级的优化之路" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://czasg.github.io/docusaurus/blog/2022/03/18/数据库单表十亿量级的优化之路" hreflang="x-default"><link rel="stylesheet" href="/docusaurus/assets/css/styles.cfdc25de.css">
<link rel="preload" href="/docusaurus/assets/js/runtime~main.13fe29bd.js" as="script">
<link rel="preload" href="/docusaurus/assets/js/main.1b0874ee.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docusaurus/"><div class="navbar__logo"><img src="/docusaurus/img/logo.svg" alt="Czasg" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/docusaurus/img/logo.svg" alt="Czasg" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Czasg</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docusaurus/blog">博客</a><a class="navbar__item navbar__link" href="/docusaurus/note/intro">文档</a><a class="navbar__item navbar__link" href="/docusaurus/author/intro">关于我</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/czasg" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌙</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">☀</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">全部博文</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/04/01/记一次redis查询异常">记一次 redis 查询 异常</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/03/28/golang选项模式">golang 选项模式</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/03/27/golang-GMP模型">golang 的 CSP&amp;GMP 模型</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/03/25/记一次pg迁移k8s的坑点">记一次pg迁移k8s的坑点</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/03/24/make和new之间的区别">make和new之间的区别</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/03/23/golang测试梳理">golang测试梳理</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/03/22/记一次关于httpClient的坑点">记一次关于 httpClient 的坑点</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/docusaurus/blog/2022/03/18/数据库单表十亿量级的优化之路">数据库单表十亿量级的优化之路</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/02/22/数据库是否适合容器化部署">数据库是否适合容器化部署</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/02/17/golang升级导致goland不可用">记一次 golang 升级导致的 goland 不可用</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/02/02/jmeter及性能测试">Jmeter及性能测试</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/01/20/常用sql操作">常见 sql 批量操作</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2022/01/12/nginx配置说明">nginx 配置说明</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/27/golang内存管理">golang内存管理</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/26/python内存管理">python内存管理</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/24/raid初识">RAID 独立磁盘冗余阵列</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/23/k8s资源配额">初步了解 k8s 资源配额</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/22/golang-cmd模块导致的进程泄漏">记一次 golang cmd 模块导致的进程泄漏</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/21/cpu调度">cpu 调度</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/15/字符编码">字符编码</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/13/gRPC负载均衡">基于 gRPC 实现负载均衡</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/10/关于副业的一些思考">关于副业的一些思考</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/12/03/Github搭建Docusaurus站点">Github 搭建 Docusaurus 站点</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/11/27/关于协程的一些理解">关于协程的一些理解</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/11/20/golang-interface坑点">golang interface 坑点</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/11/19/golang切片坑点">golang 切片坑点</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/11/18/golang继承的坑点">golang 关于继承的坑点</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/11/04/python生成器与迭代器理解">python 生成器与迭代器理解</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/docusaurus/blog/2021/11/03/python基础数据类型">python 基础数据类型中隐藏的知识点</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">数据库单表十亿量级的优化之路</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-03-18T00:00:00.000Z" itemprop="datePublished">March 18, 2022</time> · <!-- -->15 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/czasg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/czasg.png" alt="Czasg"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/czasg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Czasg</span></a></div><small class="avatar__subtitle" itemprop="description">陈大哥</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在常规数据库中，单表数据量到达百万时，查询方面就可能出现性能问题。而当单表数据量达到千万量级时，不仅查询，连索引维护也可能出现问题。<br>
<!-- -->此次我们的主角是&quot;单表量级十亿&quot;，本文章主要记录在优化期间的一些思路与实现。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="背景介绍">背景介绍<a aria-hidden="true" class="hash-link" href="#背景介绍" title="Direct link to heading">​</a></h2><ul><li><strong>数据库</strong>：postgres  </li><li><strong>数据库配置</strong>：4c8g + ssd</li><li><strong>表名</strong>：czasg（已脱敏）</li><li><strong>表量级</strong>：10亿  </li><li><strong>表字段</strong>：（已脱敏）<ul><li><strong>key</strong>：主键，类型 text</li><li><strong>value</strong>： 类型 text</li></ul></li><li><strong>业务需求</strong>：每天会有一批数据源，400w 左右，需求就是写入这批数据，并输出实际新增和更新的数据。</li></ul><p>当前线上处理方式比较常规，主要包括下面两个步骤：</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="1创建临时表写入数据">1、创建临时表，写入数据<a aria-hidden="true" class="hash-link" href="#1创建临时表写入数据" title="Direct link to heading">​</a></h4><p>创建临时表，存储业务待处理数据，总量在 400w 上下。（数据插入过程略）</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TEMPORARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> tmp_czasg </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain">    </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DROP</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>创建临时表，用于存储最终更新数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TEMPORARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> tmp_czasg_update </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain">        </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain">      </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    old_value  </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DROP</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="2join-计算结果集">2、join 计算结果集<a aria-hidden="true" class="hash-link" href="#2join-计算结果集" title="Direct link to heading">​</a></h4><p>以 key 为连接条件 join 原表，再过滤出 value 不同或者原表 value 为空的数据.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> tmp_czasg_update </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> newkv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newkv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tmp_czasg </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> newkv </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> czasg </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> kv </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> newkv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> newkv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="3将结果集更新至表-czasg">3、将结果集更新至表 <code>czasg</code><a aria-hidden="true" class="hash-link" href="#3将结果集更新至表-czasg" title="Direct link to heading">​</a></h4><p><code>tmp_czasg_update</code> 中 old_value 为空的表示新增数据，我们将它插入到原表中。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> czasg </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tmp_czasg_update </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> old_value </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>tmp_czasg_update</code> 中 old_value 非空的表示更新数据，我们将它更新到原表中。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> czasg </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> kv </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newkv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tmp_czasg_update </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> old_value </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> newkv </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newkv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">key</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>至此业务结束。根据当前线上情况，执行完一次需要 N（N &gt;= 2）小时。</p><p>优化需求：由于该业务会长时间阻塞，影响其他关联业务，<strong>希望减少此阶段的执行时间。</strong></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="优化之路痛点分析">优化之路：痛点分析<a aria-hidden="true" class="hash-link" href="#优化之路痛点分析" title="Direct link to heading">​</a></h2><p>看完上面的背景介绍后，我们应该已经初步了解业务流程了，整理如下图：<br>
<img src="/docusaurus/assets/images/data-update-88b60cabf7dd6d40a060adc7a5de11ee.png"></p><p>可以看出，主要涉及到的操作就是对数据表更新并生成版本更新包。</p><p>现在我们来拆解其中的流程，大致分析下耗时的原因：</p><p>1、创建临时表<br>
<!-- -->2、数据写入临时表<br>
<!-- -->3、<strong>关联计算最终待作业的数据</strong><br>
<!-- -->4、<strong>插入新数据</strong><br>
<!-- -->5、更新旧数据<br>
<!-- -->6、导出结果集   </p><p>在上述流程中，主要耗时点就是步骤 3 和 4。<br>
<!-- -->步骤 3 耗时是因为数据量过大，关联过程无法全程在内存中操作，需要借用磁盘来完成中间计算。<br>
<!-- -->步骤 4 耗时是因为存在索引，对这个量级的索引进行增删操作都会非常耗时。     </p><p>首先，针对量级过大的问题，解决方案比较统一，那就是进行水平拆分，尽可能减小表的大小。<br>
<!-- -->其次，针对索引导致的插入/删除耗时，解决方案也比较简单，就是插入/删除前，先 <code>DROP INDEX</code>，执行完操作后，再 <code>CREATE INDEX</code>。<br>
<!-- -->在这里我们之所以不这样做，是因为重建一张 10亿 量级表的索引，不见得比当前方案快多少。     </p><p>有了大致思路，我们再来想想具体的落地方案。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="优化之路表分区">优化之路：表分区<a aria-hidden="true" class="hash-link" href="#优化之路表分区" title="Direct link to heading">​</a></h2><p>针对第一个问题，我们计划选择水平拆分这张大表。<br>
<!-- -->拆分时要考虑到单表的大小，最好能控制在百万级。<br>
<!-- -->所以我们可以选择将这张 10亿 大表拆分成 256 张小表，这样平均到每张表的大小就是 400w 左右了。</p><p>一般拆分的方式就是创建多张物理表，然后将数据按照某种规则均匀的插入到这些表中，从而减小单表的大小。<br>
<!-- -->但我们业务场景并没有特别复杂，在这里我们选择了<strong>表分区</strong>。</p><p>自然而然，<code>key</code> 字段也就成了我们首选的分区条件。<br>
<!-- -->由于该字段是随机字串，没有规律，只能采用哈希的方式散射到各个分区。<br>
<!-- -->然后我在分区内创建 <code>key_btree_index_key</code> 索引，此时每个分区的索引大小就可以控制在较小的范围内了。  </p><p>到这里，初步优化方案已经形成。但考虑到随机字串生成的索引，无论在空间还是性能上都有所欠缺，
所以本着一步优化到位的想法，我们决定重新设计字段索引：<br>
<!-- -->1、新增一个字段 <code>key_crc32</code>，用于存储 <code>key</code> 值计算出的哈希数，此数位于 <code>1 ~ 2^32</code> 之间。<br>
<!-- -->2、将分区条件设定为 <code>key_crc32</code><br>
<!-- -->3、创建分区索引 <code>key_crc32_btree_index_key</code>     </p><p>至此，我们的表分区方案初步落地。索引这一块属于过度设计，因为引入了新字段，所以是否属于正向优化，有待考量。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>表继承</h5></div><div class="admonition-content"><p>在 postgres 中，继承可以快速的<strong>关联、区分</strong>多张表，让数据维护更加高效。  </p><p>使用继承时，至少需要有一张源表，然后通过指定源表来创建继承表。<br>
<!-- -->对于继承表来说，此时的继承表将<strong>拥有源表的全部列</strong>，并且可以自定义额外的列属性。<br>
<!-- -->对于源表来说，此时的源表将可以检索<strong>自身以及继承表的全部数据</strong>。   </p><p>在这里我们举一个例子，假设你有一张表 <code>cities</code>，里面存放了国内外所有的城市。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> cities </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name      </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">-- 城市名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    altitude  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">-- 城市海拔高度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>可是每个国家只有一个首都城市，现在有业务需求要快速筛分首都城市。<br>
<!-- -->为了实现这个需求，我们可能需要给这张表加一个字段，或者重新创建一张首都城市的表，这些都是不错的实现方案。<br>
<!-- -->现在，让我们用继承来实现这个需求：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> capitals </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    country  </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">-- 所属国</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cities</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在这里我们创建继承表 <code>capitals</code>，继承自 <code>cities</code>。这时我们可以这样存储数据：<br>
<!-- -->1、将首都城市存放至 <code>capitals</code>，并指定所属国。<br>
<!-- -->2、将其余城市存放至 <code>cities</code>。   </p><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">查询所有城市中，海拔高于500的城市</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cities </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> altitude </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">查询非首都城市中，海拔高于500的城市</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> ONLY cities </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> altitude </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- 通过 ONLY 限制仅查 cities 表</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">查询所有首都城市中，海拔高于500的城市</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> capitals </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> altitude </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>表分区</h5></div><div class="admonition-content"><p>在 postgres 中，表分区是将一张大表，划分成一些小的物理上的片。这样划分的好处有很多：  </p><ul><li>某些场景下读写性能提升。<strong>减小单表数据量、索引大小</strong>。      </li><li>某些场景下，<strong>批量操作</strong>性能将得到极大提升。     </li><li>可以按实际需求，将价值低的数据块迁移至便宜且较慢的存储介质上。   </li></ul><p>创建表分区的方式有两种：<br>
<!-- -->第一种，初始化时通过 <code>PARTITION BY</code> 声明该表为分区表，且需要指定分区键，然后就可以创建分区了。</p><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">声明分区表</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> measurement </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    city_id    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logdate    </span><span class="token keyword" style="color:#00009f">date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    peaktemp   </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unitsales  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logdate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- 分区支持范围划分、列表划分、哈希划分</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">创建分区</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> measurement_y2006m02 </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">OF</span><span class="token plain"> measurement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2006-02-01&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2006-03-01&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> measurement_y2006m03 </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">OF</span><span class="token plain"> measurement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2006-03-01&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2006-04-01&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>创建分区之后，你对 <code>measurement</code> 的操作都会被重定向到某个分区，比如：<br>
<!-- -->1、插入一条数据到 <code>measurement</code> 中，当这条数据被<strong>映射到 <code>measurement_y2006m02</code> 时</strong>，
这条数据将被<strong>重定向</strong>到 <code>measurement_y2006m02</code> 分区。<br>
<!-- -->2、读取一条数据，当这条数据被映射到 <code>measurement_y2006m02</code> 时，查询也会重定向。</p><p>第二种，通过继承实现表分区。</p><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">创建继承表</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> measurement_y2006m02 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">measurement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>为了实现类似分区表的能力，我们引入触发器：</p><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">创建触发器与函数</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> measurement_insert_trigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRIGGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> measurement_y2008m01 </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">RETURN</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRIGGER</span><span class="token plain"> insert_measurement_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BEFORE </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> measurement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR EACH ROW</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> measurement_insert_trigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>我们可以看到通过继承与触发器的方式，我们可以间接实现分区表的能力，他相比于声明式分区表，优势就是限制会宽松一些，
比如我们可以为每一个分区创建不同的字段的不同索引，但代价就是更复杂维护逻辑。</p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="优化之路继承式分区表填坑">优化之路：继承式分区表填坑<a aria-hidden="true" class="hash-link" href="#优化之路继承式分区表填坑" title="Direct link to heading">​</a></h2><p>按照预期方案实现后，我拷贝了一份正式环境数据执行测试，结果令人震惊，耗时 3小时 😱😱😱<br>
<!-- -->就离了个大谱，妥妥的反向优化。 😭😭😭  </p><p>理论和实际差距过大，不得不让我开始反思到底是哪里出现了异常。<br>
<!-- -->通过日志发现在关联计算、插入新数据、更新数据这些流程都非常耗时。<br>
<!-- -->但是我们已经设计了分区，减小了每张表的数量和索引大小。所以理论上操作不可能会更耗时。  </p><p>通过进一步打断点输出日志，我发现了继承式分区表的触发器，在执行操作时性能非常拉跨。</p><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">初始化表分区</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_0 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">CHECK</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cloud_search_kvs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_0_0 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">CHECK</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">858993459</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_0_1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">CHECK</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">858993459</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1717986918</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_0_2 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">CHECK</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1717986918</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2576980377</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_0_3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">CHECK</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2576980377</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3435973836</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_0_4 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">CHECK</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3435973836</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4294967295</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> INHERITS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">初始化触发器</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> origin_0_insert_trigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">RETURNS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRIGGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">858993459</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> origin_0_0 </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ELSIF </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">858993459</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1717986918</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> origin_0_1 </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ELSIF </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1717986918</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2576980377</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> origin_0_2 </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ELSIF </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2576980377</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3435973836</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> origin_0_3 </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ELSIF </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3435973836</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4294967295</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> origin_0_4 </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NEW</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">RETURN</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>触发器的原理就是通过查询条件，将数据重定向到指定分区。<br>
<!-- -->上面的初始化语句都是简化后的，实际上有 256 个判断条件，而且触发器每次似乎只能执行单条语句，这也导致了整体性能急剧下降。<br>
<!-- -->我们方案设计上没有太大的问题，但是执行方式有问题，触发器的重定向不适合这种场景，所以我只能尝试自己维护。</p><p>重新优化思路，获取每个分区的数据，直接和目标分区作关联运算，绕开触发器。  </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TEMPORARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> temp_diff_</span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">d </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_crc32 </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    old_v </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DROP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> temp_diff_w </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> temp_add </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">d </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> k_crc32 </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> temp_diff_</span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">d </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> tadd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tadd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tadd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tadd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">origin_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> temp_diff_w </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> tadd </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> origin </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> kv </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> tadd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> tadd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tadd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> kv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> temp_diff </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> temp_diff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> origin </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> o </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> temp_diff_</span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">d </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> old_v </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_crc32 </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_btree_index_key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> origin </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k_crc32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> origin_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k_crc32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> origin_id </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> temp_diff_</span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">d </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> old_v </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> origin_btree_index_key </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> origin </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">btree</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k_crc32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> temp_diff_</span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>以上是部分执行语句（已脱敏），可以看出，第一步就取出了分区数据，然后执行关联运算获取最终结果集，再将结果集数据写入源表即可。  </p><p>再次测试，执行一次大概在 半小时 左右，完美 🤠🤠🤠</p><br><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>👇👇👇</h5></div><div class="admonition-content"><p><strong>本文作者:</strong> Czasg<br>
<strong>版权声明:</strong> 转载请注明出处哦~👮‍</p></div></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/docusaurus/blog/tags/数据库">数据库</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/czasg/docusaurus/edit/main/blog/2022/03-18-数据库单表十亿量级的优化之路/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docusaurus/blog/2022/03/22/记一次关于httpClient的坑点"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->记一次关于 httpClient 的坑点</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docusaurus/blog/2022/02/22/数据库是否适合容器化部署"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">数据库是否适合容器化部署<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#背景介绍" class="table-of-contents__link toc-highlight">背景介绍</a></li><li><a href="#优化之路痛点分析" class="table-of-contents__link toc-highlight">优化之路：痛点分析</a></li><li><a href="#优化之路表分区" class="table-of-contents__link toc-highlight">优化之路：表分区</a></li><li><a href="#优化之路继承式分区表填坑" class="table-of-contents__link toc-highlight">优化之路：继承式分区表填坑</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Czasg's Site.</div></div></div></footer></div>
<script src="/docusaurus/assets/js/runtime~main.13fe29bd.js"></script>
<script src="/docusaurus/assets/js/main.1b0874ee.js"></script>
</body>
</html>