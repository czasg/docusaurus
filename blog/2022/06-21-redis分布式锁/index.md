---
title: redis 分布式锁
authors: [czasg]
tags: [redis]
---

<!--
https://juejin.cn/post/6936956908007850014
-->

并发场景下的**锁机制**，其实就是用来保护不同线程对**共享资源**的访问，这样可以确保程序按预设的逻辑执行。
**分布式锁**也是一样的原理，它是用于分布式系统并发场景下访问共享资源的一种锁机制。   

一把合格的分布式锁，应该至少具备以下特征：
* 互斥性：任意时刻，只有一个客户端持有。
* 超时机制：持有锁并超时时，可以自动释放，避免死锁。
* 安全性：在未超时场景下，锁只能被持有者释放。

<!--truncate-->

## redis 单机器分布式锁
### setnx
这是一个基于 setnx 实现的一个完整的分布式锁，其中主要包含三个 redis 关键字操作。
```shell script
SETNX key uniqueValue
EXPIRE key 10
DEL key
```
具体的操作就是：   
1、创建随机的唯一值  
2、使用 setnx 赋值，赋值成功，则获取分布式锁

#### setnx key uniqueValue
`setnx` 是 redis 的一个关键字指令操作，该指令是原子操作，其作用是只有当 key 不存在的情况下，才能赋值成功。所以基于 setnx 指令我们呢可以轻松的实现互斥性。

具体操作就是

所以基于该指令我们可以很快的实现一个分布式锁。目前原子操作 setnx 已经实现了互斥性。  

然后时超时机制。我们需要注意到，一旦客户端因为某些异常，需要长时间持有锁，就会导致整个系统跟着阻塞。为了避免这种情况，我们还需要给锁设置一个过期时间。   
`expire key num` 是 redis 的指令操作，其作用是给 key 设置过期时间。

当出现锁过期的场景时，前一个持锁用户，需要感知到当前锁不属于他，进而避免误删锁。

#### expire key 10

#### del key

```shell script
SETNX key value
EXPIRE key 10
DEL key
```

而 redis 作为主流的内存数据库，其 `setnx` 命令，可以很轻松的实现一个单机的分布式锁。对于redis集群，也有 `redlock` 算法保证锁机制。

## redis 多机分布式锁




<br/>

:::info 👇👇👇
**本文作者:** Czasg
**版权声明:** 转载请注明出处哦~👮‍
:::
